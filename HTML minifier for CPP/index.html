<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NODEMCU-V3 LED WEBSOCKET CONTROLS</title>
</head>
<header>
    <h3>ARDUINO ESP8266 LED_BUILTIN CONTROLS</h3>
    <h4>OVER HTTP/WS BY KOF.READIE</h4>
</header>
<body>
    <hr>
    <div>LED TOGGLE: <input type="checkbox" id="ledState"></div>
    <hr>
    <div>
        <p>LED SEQUENCE:</p>
        <p>Brightness: 0=on, 1023=off</p>
        <p>Delay: duration of brightness in milliseconds (min=1, max=10000)</p>
        <input type="number" min="0" max="1023" id="seqBright" placeholder="Brightness">
        <input type="number" min="1" max="10000" id="seqDelay" placeholder="Delay">
        <input type="button" id="addToSequence" value="Add to sequence">
        <input type="button" id="clearSequence" value="Clear sequence">
        <textarea id="sequence" readonly>[]</textarea>
        <input type="button" id="sendSequence" value="Submit sequence">
    </div>
    <hr>
    <div>
        <p>LED SLIDER:</p>
        <input type="range" min="0" max="1023" value="512" id="sldBright">
    </div>
    <hr>
    <script>
        var ws;
        var ledState;

        window.addEventListener("load", () =>
        {
            setupWebsocket();
            ledState = document.querySelector("#ledState");
            brightness = document.querySelector("#brightness");

            ledState.addEventListener("click", ledCheckbox);
            document.querySelector("#addToSequence").addEventListener("click", addToSequence);
            document.querySelector("#clearSequence").addEventListener("click", clearSequence);
            document.querySelector("#sendSequence").addEventListener("click", sendSequence);
            document.querySelector("#sldBright").addEventListener("change", sldBright); /*input event was too fast and caused the program to crash*/
            document.querySelector("#sldBright").addEventListener("input", sldBrightVisual);
        });

        function setupWebsocket()
        {
            ws = new WebSocket(`ws://${window.location.hostname}:81/`);
            /*ws = new WebSocket(`ws://192.168.1.109:81/`);*/
            function resetConnection(event) { setTimeout(() => { setupWebsocket(); }, 5000); }
            ws.onerror = resetConnection;
            ws.onclose = resetConnection;
            ws.addEventListener("message", (event) =>
            {
                console.log(event.data);
                let message = event.data.split(",");
                message[0] = parseInt(message[0]);
                message[1] = parseInt(message[1]);
                ledState.checked = message[0] == 1023 ? false : true;
                let sldBright = document.querySelector("#sldBright");
                sldBright.style.backgroundColor = `rgba(0, 75, 255, ${((parseInt(sldBright.value = 1023 - message[0]) * 100) / 1023)/100})`;
            });
        }

        function ledCheckbox()
        {
            ledState.checked = !ledState.checked;
            ws.send(JSON.stringify([[ledState.checked ? 1023 : 0, 0]]));
        }

        var sequenceValue = [];
        function addToSequence()
        {
            let seqBright = document.querySelector("#seqBright");
            let seqDelay = document.querySelector("#seqDelay");
            let seqBrightVal = Math.round(parseInt(seqBright.value));
            let seqDelaytVal = Math.round(parseInt(seqDelay.value));
            if (seqBrightVal > 1023) { seqBrightVal = 1023; }
            else if (seqBrightVal < 0) { seqBrightVal = 0; }
            if (seqDelaytVal > 10000) { seqDelaytVal = 10000; }
            else if (seqDelaytVal < 1) { seqDelaytVal = 1; }
            sequenceValue.push([seqBrightVal, seqDelaytVal]);
            document.querySelector("#sequence").value = JSON.stringify(sequenceValue);
            seqBright.value = "";
            seqDelay.value = "";
        }

        function clearSequence()
        {
            sequenceValue = [];
            document.querySelector("#sequence").value = "[]";
        }

        function sendSequence() { if (sequenceValue.length != 0) { ws.send(JSON.stringify(sequenceValue)); } }

        function sldBright() { ws.send(JSON.stringify([[1023 - parseInt(document.querySelector("#sldBright").value), 0]])); }

        function sldBrightVisual()
        {
            /*https://stackoverflow.com/questions/929103/convert-a-number-range-to-another-range-maintaining-ratio*/
            let sldBright = document.querySelector("#sldBright");
            sldBright.style.backgroundColor = `rgba(0, 75, 255, ${((parseInt(sldBright.value) * 100) / 1023)/100})`;
        }
    </script>

    <style>
        #sequence
        {
            min-width: 100%;
            max-width: 100%;
            min-height: 50px;
        }

        #sldBright { -webkit-appearance: none; border: 1px solid black; }
    </style>
</body>
<footer>
    <script id="cppjs" src="cpp.js"></script>
</footer>
</html>